# 输入与输出

输入与输出并不是C语言本身的组成部分

ANSI 标准精确地定义了这些库函数，所以，在任何可以使用 C语言的系统中都有这些函数的兼容形式。

## 7.1 标准输入/输出

文本流由一系列行组成，每一行的结尾是一个换行符。如果系统没有遵循这种模式，则标准库将通过一系列
措施使的该系统适应这种模式。

`getchar` 函数从**标准输入**中(一般为键盘)一次读取一个字符，在每次被调用时返回下一个字符。若
遇到文件结尾，则返回EOF。符号常量EOF在文件 `<stdio.h>` 中定义，其值一般为 -1

在许多环境中，可以使用符号 `<` 来实现输入重定向，它将键盘输入替换为文件输入：

```sh
prog < infile
```

在某些系统中，下列命令行将运行两个程序 otherprog 和 prog，并将程序 otherprog 的标准输出通过
管道重定向到程序 prog 的标准输入上

```sh
otherprog | prog
```

`putchar(c)` 将字符 c 送至标准输出，如果没有发生错误，返回输出的字符，如果发生错误，则返回 EOF

使用输入/输出库函数的每个源程序文件必须在引用这些函数之前包含下列语句：

```c
#include <stdio>
```

头文件 `<stdio.h>` 中的 getchar 和 putchar “函数” 以及 `<ctype.h>` 中的 tolower 函数，一般都是宏，
这样就避免了对每个字符都进行函数调用的开销。

## 7.2 格式化输出 - printf 函数

```c
int printf(char *format, arg1, arg2, ...)
```

函数 printf 在输出格式 format 的控制下，将其参数进行转换与格式化，并在标准输出设备上打印出来。它返回值为打印的字符数。

```c
int sprintf(char *string, char *format, arg1, arg2, ...)
```

sprintf 函数和 printf 函数一样，按照 format 格式格式化参数序列 arg1、arg2、...，但它将输出结果存在 string 中，当然，
string 必须足够大以存放输出结果。


## 7.3 变长参数表

```c
int printf(char *fmt, ...)
```

其中，省略号表示参数的数量和类型是可变的。省略号只能在出现在参数表的尾步。
标准头文件 `<stdarg.h>` 中包含了一组宏定义，他们对如何遍历参数表进行了定义。

- va_list 类型用于声明一个变量(比如：ap)，该变量将依次引用各参数
- va_start 将 ap 初始化为指向第一个无名参数的指针，在使用 ap 之前，该宏必须被调用一次。参数表必须至少包括一个有名参数，va_start 将最后一个有名参数作为起点
- va_arg 每次被调用都将返回一个参数，并将 ap 指向下一个参数。va_arg 使用一个类型名来决定返回的对象类型、指针移动的步长
- va_end 必须在函数返回之前调用，以完成一些必要的清理工作

```c
#include <stdarg.h>

void minprintf(char *fmt, ...) {
	va_list ap; // 依次指向每个无名参数
	va_start(ap, fmt); // 将 ap 指向第一个无名参数

	int ival = va_arg(ap, int); // 将下一个无名参数作为int 类型参数获取

	va_end(ap); // 结束时的清理工作
}
```

## 格式化输入 - scanf函数

```c
int scanf(char *format, ...)
```

scanf 函数从标准输入中读取字符序列，按照 format 中的格式说明对字符序列进行结识，并把结果保存到其余的参数中。
除格式参数 format 外，其他所有参数都必须是指针，用于指定经格式转换后的相应输入保存的位置。
当 scanf 函数扫描完成其格式串，或者碰到某些输入无法与格式控制说明匹配的情况时，该函数将终止，同时，成功匹配
并赋值的输入项的个数将作为函数值返回。
如果到达文件的结尾，该函数将返回 EOF。下一次调用 scanf 函数将从上一次转换的最后一个字符的下一个字符的开始继续搜索。

```c
int sscanf(char *string, char *format, arg1, arg2, ...)
```

sscanf 函数用于从一个字符串（而不是标准输入）中读取字符序列。

格式串可能包含下列部分：

- 空格和制表符，在处理过程中将被忽略
- 普通字符（不包括 %），用于匹配输入流中下一个非空白符字符
- 转换说明，依次由
	- 一个 `%`
	- 一个可选的赋值禁止字符 `*`，如果转换说明中有赋值禁止符，则跳过该输入字段，不进行赋值
	- 一个可选的数值（指定最大字段宽度）
	- 一个可选的 h、l或L字符（指定目标对象的宽度）
	- 以及一个转换字符组成

输入字段定义为一个不包括空白符的字符串，其边界定义为到下一个空白符或到达指定的字段宽度。这表明 scanf 函数将越过行边界读取输入。

scanf 函数忽略格式串中的空格和制表符。此外，在读取输入值时，他将跳过空白符。如果读取格式不固定的输入，最好每次读取一行，然后
再用 sscanf 将合适的格式分离出来读入。

scanf 函数可以和其他输入函数混合使用，无论调用哪个输入函数（因为读取的位置记录在 File.cnt 中），下一个输入函数的调用将从 scanf
没有读取的第一个字符处开始读取数据。

## 文件访问

```c
/*
	name 是文件名
	mode 是访问模式，包括：读（r）、写（w）、追加（a）
*/
FILE *fopen(char *name, char *mode);
```

在读写一个文件之前，必须通过库函数 `fopen` 打开文件，并返回一个随后可以用于文件读写操作的指针。
该指针称为文件指针，它指向一个包含文件信息的结构。`<stdio.h>` 中已经定义了一个包括这些信息的结构 FILE。
FILE 是一个像 int 一样的一个类型名，而不是结构标记。它是通过 typedef 定义的。

```c
int getc(FILE *fp)
int putc(int c, FILE *fp)
```

文件被打开后，就需要考虑采用哪种方法对文件进行读写。getc 和 putc 函数最为简单。
getc 从文件中返回下一个字符，如果达到文件尾或出现错误，该函数将返回 EOF。
putc 函数将字符 c 写入到 fp 指向的文件中，并返回写入的字符。如果发生错误，则返回 EOF。
类似于 getchar 和 putchar，getc 和 putc是宏而不是函数。

进程启动时，系统负责打开三个文件，这三个文件分别是标准输入、标准输出和标准错误，相应的文件指针分别是stdin指向键盘和
stdout、stderr指向显示器。stdin、stdout 和 stderr都可以被重定向到文件或管道。

文件指针 stdin 与 stdout 都是 FILE* 类型的对象。但他们都是常量，而非变量，因此不能对他们赋值。

```c
int fscanf(FILE *fp, char *format, ...);
int fprintf(FILE *fp, char *format, ...);
```
对文件的格式化输入或输出，可以使用函数 fscanf 和 fprintf。他们于 scanf 和 printf 函数的区别仅仅在于第一个参数是一个指向
所要读写的文件的指针。

```c
int fclose(FILE *fp);
```

fclose 执行和 fopen 相反的操作，它断开由 fopen 函数建立的文件指针和外部名之间的连接，并释放文件指针以供其他文件使用。
因为大多操作系统都限制了一个程序可以同时打开的文件数。另一个原因是，fclose 将缓冲区中由 putc 函数正在收集的输出写到文件中。
当程序正常终止时，程序会自动为每个打开的文件调用 fclose 函数。
如果不需要使用 stdin 与 stdout，可以把他们关闭掉，也可以通过库函数 freopen 重新指定他们。

## 错误处理 - stderr 和 exit

exit 函数为每个已打开的输出文件调用 fclose 函数，以将缓冲区中的所有输出写到相应的文件中。

```c
int ferror(FILE *fp)
```

如果流 fp 中出现错误，则函数 ferror 返回一个非 0 值。

```c
int feof(FILE *fp)
```

如果指定的文件到达文件结尾，函数 feof 将返回一个非 0 值。

## 行输入和行输出

```c
char *fgets(char *line, int maxline, FILE *fp)
int fputs(char *line, FILE *fp)
```

标准库提供了 fgets 函数从 fp 指向的文件中读取下一个输入行（包括换行符），并将它存放在字符数组 line 中，它最多多去 maxline - 1 个字符。
输出函数 fputs 将一个字符串（不需要包括换行符）写入到一个文件中，如果发生错误，该函数将返回 EOF，否则返回一个非负值。
库函数 gets 和 puts 的功能 fgets 和 fputs 函数类似，但他们是对 stdin 和 stdout 进行操作。
有一点需要注意，gets 函数在读取字符串时将删除结尾的换行符（'\n'），而 puts 函数在写入字符串时将在结尾添加一个换行符。

## 其他函数

### 7.8.3 ungetc 函数

```c
int ungetc(int c, FILE *fp)
```

ungetc 函数将字符 c 写回到文件 fp 中，如果执行成功，则返回 c 否则返回 EOF。每个文件只能接收一个写回字符。
ungetc 从输入流中“退回”字符，而 putc 向输入流中写入字符。ungetc 主要用于读操作，putc 主要用于写操作。

### 7.8.7 随机数发生器函数

函数 rand() 生成介于 0 和 RAND_MAX 之间的伪随机整数序列。其中 RAND_MAX 是在头文件 `<stdlib.h>` 中定义的符号常量。

函数 srand(unsigend) 设置 rand 函数的种子数。 


